# Спецзадачи и подзадачи: Подробное описание

---
<!-- 
## 1. Импорт/экспорт проектов

**Зачем:** Позволяет переносить проекты между разными инстансами MCP, делать бэкапы, делиться проектами, быстро клонировать шаблоны.

**Что даёт:**
- Миграция проектов между командами/серверами.
- Быстрое восстановление после сбоя.
- Возможность создавать шаблоны проектов.

**Сценарии использования:**
- "Сделай экспорт проекта Mirapolis для передачи в другую команду."
- "Импортируй проект из архива, чтобы быстро развернуть копию."

**Требования:**
- Экспортировать все связанные сущности (tasks, rules, docs, history, templates, embeddings).
- Корректно маппить project_id и origin при импорте.
- Обрабатывать конфликты origin (например, если такой origin уже есть).

**Edge cases:**
- Импорт с конфликтом origin — предложить переименовать или обновить существующий проект.
- Экспорт большого проекта — поддержка stream/zip, чтобы не перегружать память.

**Best practices:**
- Добавлять запись в changelog об импорте/экспорте.
- Хранить экспортированные архивы с метаданными (дата, автор, версия схемы).

**Prompt:**
- `Экспортируй проект с origin X в архив`
- `Импортируй проект из файла project_export.zip`

**Ожидаемый результат:**
- После экспорта — файл с архивом проекта.
- После импорта — новый проект с корректно восстановленными задачами, правилами, docs и т.д.

--- -->
<!-- 
## 2. Расширенная работа с эмбеддингами

**Зачем:** Позволяет делать интеллектуальный поиск, рекомендации, кластеризацию задач, шаблонов, документов на основе смысловой близости.

**Что даёт:**
- Быстрый поиск похожих задач/шаблонов/документов.
- Рекомендации по best practices.
- Аналитику и автоматизацию (например, "найди все задачи, похожие на интеграцию Stripe").

**Сценарии использования:**
- "Найди похожие задачи на 'интеграция Stripe'."
- "Порекомендуй шаблоны для React Native."

**Требования:**
- Поддержка нескольких моделей эмбеддингов (разные размерности, типы).
- Хранение метаданных (модель, дата, источник, тип сущности).
- Векторный поиск по всем сущностям.
- Кластеризация и рекомендации.

**Edge cases:**
- Несовпадение размерности эмбеддингов.
- Отсутствие эмбеддингов для некоторых задач.

**Best practices:**
- Использовать pgvector для хранения и поиска.
- Добавлять эмбеддинги при создании/обновлении задач, docs, шаблонов.

**Prompt:**
- `Добавь эмбеддинг для задачи X с моделью Y`
- `Найди похожие задачи на "интеграция Stripe"`

**Ожидаемый результат:**
- Быстрый и релевантный поиск по смыслу, а не только по ключевым словам.

--- -->

<!-- ## 3. Механизм "глобальных" правил/шаблонов

**Зачем:** Позволяет централизованно управлять best practices, которые применяются ко всем проектам по умолчанию.

**Что даёт:**
- Единые стандарты для всех проектов.
- Быстрое обновление правил для всех проектов.
- Возможность наследовать или переопределять правила на уровне проекта.

**Сценарии использования:**
- "Покажи все глобальные правила."
- "Сделай правило X глобальным для всех проектов."

**Требования:**
- Хранение правил/шаблонов с project_id = NULL.
- Наследование глобальных правил при создании нового проекта.
- Возможность отключить/переопределить правило на уровне проекта.

**Edge cases:**
- Конфликт между глобальным и локальным правилом.
- Обновление глобального правила — как это влияет на существующие проекты.

**Best practices:**
- Явно помечать глобальные правила/шаблоны.
- Логировать изменения глобальных правил.

**Prompt:**
- `Покажи все глобальные правила`
- `Сделай правило X глобальным для всех проектов`

**Ожидаемый результат:**
- Глобальные правила автоматически применяются ко всем новым проектам. -->

<!-- ---

## 4. GraphQL (Apollo) endpoint

**Зачем:** Дает гибкий, современный API для интеграции с UI, мобильными приложениями, внешними сервисами.

**Что даёт:**
- Гибкие queries и mutations.
- Поддержка подписок (live-обновления через WebSocket).
- Совместимость с Apollo-клиентом.

**Сценарии использования:**
- "Сделай GraphQL-запрос на получение всех задач проекта X."
- "Подпишись на новые задачи через GraphQL."

**Требования:**
- Реализовать GraphQL endpoint (Strawberry/Ariadne).
- Описать схему для всех сущностей.
- Поддержка подписок (subscriptions).

**Edge cases:**
- Ограничение прав доступа (авторизация).
- Большие выборки данных (пагинация).

**Best practices:**
- Использовать типизацию и валидацию схемы.
- Документировать все queries/mutations.

**Prompt:**
- `Сделай GraphQL-запрос на получение всех задач проекта X`
- `Подпишись на новые задачи через GraphQL`

**Ожидаемый результат:**
- UI/клиенты могут гибко получать и изменять данные, подписываться на события.

--- -->
<!-- 
## 5. Авторизация и регистрация

**Зачем:** Обеспечивает безопасность, разграничение доступа, историю действий по пользователям.

**Что даёт:**
- Персональные проекты, задачи, история.
- Роли (admin, user, agent).
- Безопасность данных.

**Сценарии использования:**
- "Зарегистрируй нового пользователя и выдай токен."
- "Покажи все проекты, доступные пользователю X."

**Требования:**
- JWT или OAuth2.
- Привязка проектов/действий к user_id.
- Ограничение доступа по ролям.

**Edge cases:**
- Потеря токена, истечение срока действия.
- Эскалация прав.

**Best practices:**
- Хранить пароли в хэше.
- Использовать refresh-токены.

**Prompt:**
- `Зарегистрируй нового пользователя и выдай токен`
- `Покажи все проекты, доступные пользователю X`

**Ожидаемый результат:**
- Только авторизованные пользователи могут работать с проектами.

--- -->
<!-- 
## 6. Снапшоты и changelog

**Зачем:** Позволяет фиксировать состояние проекта/задачи/шаблона в любой момент, отслеживать историю изменений.

**Что даёт:**
- Возможность отката к любому состоянию.
- Прозрачная история изменений (changelog).
- Интеграция с git (commit, tag, MR).

**Сценарии использования:**
- "Сделай снапшот кастомного хука RTK Query."
- "Покажи changelog за последний месяц для проекта X."

**Требования:**
- Endpoint для создания снапшота (git commit/tag, запись в changelog).
- Привязка снапшота к задаче, тегу, milestone.
- Генерация changelog.md.

**Edge cases:**
- Конфликт при создании снапшота (несохранённые изменения).
- Слияние changelog из разных веток.

**Best practices:**
- Автоматически добавлять changelog при каждом git commit.
- Хранить changelog в базе и в файле.

**Prompt:**
- `Сделай снапшот кастомного хука RTK Query`
- `Покажи changelog за последний месяц для проекта X`

**Ожидаемый результат:**
- Можно откатиться к любому снапшоту, видеть всю историю изменений.

--- -->

## 7. Импорт/экспорт снапшотов

**Зачем:** Позволяет переносить отдельные состояния/фичи между проектами, делать backup/restore.

**Что даёт:**
- Быстрый перенос фич/шаблонов.
- Восстановление после сбоя.

**Сценарии использования:**
- "Экспортируй снапшот задачи X в файл."
- "Импортируй снапшот из файла snapshot_X.json."

**Требования:**
- Экспорт снапшота как отдельного файла или git-branch/tag.
- Импорт с маппингом project_id, task_id.

**Edge cases:**
- Конфликт task_id при импорте.
- Несовместимость версий.

**Best practices:**
- Хранить снапшоты с метаданными (дата, автор, описание).
- Проверять совместимость при импорте.

**Prompt:**
- `Экспортируй снапшот задачи X в файл`
- `Импортируй снапшот из файла snapshot_X.json`

**Ожидаемый результат:**
- Снапшоты легко переносить между проектами.

---

## 8. Интеграция с merge request/pull request

**Зачем:** Обеспечивает контроль качества, ревью, автоматизацию CI/CD.

**Что даёт:**
- Безопасное внесение изменений.
- Возможность ревью и обсуждения.
- Интеграция с тестами и деплоем.

**Сценарии использования:**
- "Создай merge request для ветки feature/new-docs."

**Требования:**
- Все изменения в origin только через MR/PR, пушит только агент.
- Автоматизация создания MR через API git-сервиса.

**Edge cases:**
- Конфликт при слиянии.
- Несовпадение веток/базовых версий.

**Best practices:**
- Автоматически запускать тесты на каждый MR.
- Вести changelog по каждому MR.

**Prompt:**
- `Создай merge request для ветки feature/new-docs`

**Ожидаемый результат:**
- Все изменения проходят ревью и автоматическую проверку.

---

## Backlog (дополнительные задачи на будущее)

- Diff и сравнение версий задач, документов, файлов (API + визуализация)
- Визуализация истории и дерева изменений (Mermaid.js, Graphviz, UI)
- Автотесты и CI/CD для всех endpoint'ов (версии, rollback, файлы, аудит)
- Swagger/OpenAPI для всех endpoint'ов, расширенная документация и примеры
- UI/UX для управления снапшотами, rollback, diff, файлами, историей
- Webhooks и интеграция с внешними системами (мессенджеры, CI/CD, облако)
- Расширенная RBAC и безопасность (роли, 2FA, лимиты)
- Синхронизация между инстансами (federation, pull/push проектов)
- Расширенная аналитика и отчёты (метрики, changelog, release notes)
- Поддержка кастомных типов данных, плагинов, расширяемость
- Автотесты для подписок (subscriptions) — проверка live-обновлений
- Тесты на авторизацию/роли (если реализовано)
- Примеры интеграции с UI/внешними системами (Apollo Client, webhooks и т.д.)
- [x] Реализован endpoint POST /auth/register (регистрация пользователя)
- [x] Реализован endpoint POST /auth/login (выдача JWT)
- [x] Описаны новые endpoint'ы в README.md
- [x] Реализовано минимальное JWT middleware:
    - Проверяет JWT для всех endpoint'ов, кроме /auth/login, /auth/register, GraphQL queries
    - Пропускает только пользователей с ролью root или agent
    - Прокидывает user_id и роль в request.state
    - Возвращает 403 при ошибке
- [ ] RBAC (role-based access control) для endpoint'ов и GraphQL
- [ ] Аудит и логирование действий пользователя (user_id, endpoint, действие)
- [ ] Rate limiting на уровне middleware (например, для login)
- [ ] Интеграция с внешними провайдерами (OAuth2, SSO)
- [ ] Авторизация для подписок (GraphQL subscriptions)
- [ ] CORS и secure headers (аналог helmet)
- [ ] Глобальный error boundary для стандартизированных ошибок авторизации

# Backlog (глобальные правила/шаблоны)
- [ ] Тесты на конфликт override (глобальное vs локальное правило)
- [ ] Реализовать/уточнить стратегию обновления глобальных правил для существующих проектов
- [ ] Улучшить логирование изменений глобальных правил (кто, когда, что)
- [ ] Добавить опцию массового обновления глобальных правил (если потребуется)
- [ ] Явное помечание глобальных правил/шаблонов в API и UI (is_global)

# Актуальные задачи
- [ ] Покрыть edge cases по глобальным правилам автотестами
- [ ] Обновить документацию с примерами edge cases и best practices

# Актуальные задачи (git-снапшоты и changelog для правил/шаблонов)
- [ ] Реализовать git-снапшоты для всех правил/шаблонов:
    - Каждый файл — отдельный git-объект
    - При изменении — отдельный коммит с подробным описанием (тип, id, автор, причина)
- [ ] Реализовать API для просмотра истории изменений (git log) по каждому правилу/шаблону
- [ ] Реализовать API для отката отдельного файла (git checkout/tag/reset)
- [ ] Покрыть edge cases: batch-commit, конфликт при откате, аудит откатов
- [ ] Описать процесс снапшотов, changelog и отката в документации с примерами

_Этот список — backlog: задачи не обязательны к реализации, но могут быть полезны для масштабирования, интеграции, автоматизации или улучшения UX в будущем._

# PRIORITY TASKS: Memory Bank & Federation Development

## Кастомизация и расширяемость
- [ ] Визуальный конструктор шаблонов memory-bank (web UI)
- [ ] Marketplace шаблонов (отраслевые, командные)
- [ ] Параметризация шаблонов (переменные, автозаполнение)

## Интеграция с внешними источниками знаний
- [ ] Импорт из Confluence, Notion, Wiki (markdown)
- [ ] Синхронизация с корпоративными базами знаний
- [ ] Интеграция с Apidog, Swagger, Postman (API-документация)

## Автоматизация и AI
- [ ] AI-ассистент для заполнения и обновления memory-bank
- [ ] Автоматические напоминания об обновлении
- [ ] AI-рефакторинг и предложения по структуре

## Совместная работа и ревью
- [ ] Inline-комментарии и обсуждения в memory-bank
- [ ] Система задач и todo внутри memory-bank
- [ ] Pull request/review для изменений memory-bank

## Безопасность и контроль доступа
- [ ] Ролевой доступ к разделам memory-bank
- [ ] Аудит изменений, логирование, откат
- [ ] Шифрование и резервное копирование

## Federation и обмен
- [ ] Публичные/приватные memory-bank, обмен между проектами
- [ ] Синхронизация облако/on-premise
- [ ] Автоматическое разрешение конфликтов (AI)

## Гибкая структура и навигация
- [ ] Тэги, кросс-ссылки, быстрый поиск
- [ ] Генерация оглавления, карта знаний (TOC, graph)
- [ ] Поиск по содержимому, фильтрация

## Интеграция с процессами разработки
- [ ] Автоматическое обновление из CI/CD (релизы, changelog)
- [ ] Интеграция с issue-трекерами (Jira, GitHub Issues)
- [ ] Webhooks для событий memory-bank

## Мультиязычность
- [ ] Поддержка нескольких языков для одного проекта
- [ ] Автоматический перевод ключевых разделов

## Визуализация и отчёты
- [ ] Генерация диаграмм (PlantUML, Mermaid)
- [ ] Автоматические отчёты по изменениям, покрытию
- [ ] Дашборд состояния memory-bank

## Расширение API
- [ ] REST/GraphQL endpoint'ы для всех операций с memory-bank
- [ ] WebSocket/subscribe API для real-time изменений

## Интеграция с AI-ассистентами
- [ ] Кастомные промпты и команды для Cursor, Cline, Claude, ChatGPT
- [ ] Автоматическое обновление memory-bank на основе диалогов
- [ ] Обучение AI на содержимом memory-bank

## Roadmap и архитектура
- [ ] Подготовить roadmap внедрения и архитектурную схему 

# PRIORITY TASKS: FastMCP Integration (после MemoryBank)

## Архитектура и инфраструктура
- [ ] Проанализировать, какие функции/модули экспортировать как MCP-инструменты/ресурсы
- [ ] Создать fastmcp_server.py с базовой инициализацией FastMCP
- [ ] Настроить параллельный запуск FastMCP-сервера с основным сервером

## MCP-инструменты (Tools)
- [ ] Обернуть функцию импорта проекта в @mcp.tool
- [ ] Обернуть функцию экспорта проекта в @mcp.tool
- [ ] Обернуть merge (с dry-run/diff) в @mcp.tool
- [ ] Обернуть rollback к git-снапшоту в @mcp.tool
- [ ] Обернуть batch-операции с правилами/шаблонами в @mcp.tool
- [ ] Обернуть работу с эмбеддингами (добавление, поиск, кластеризация, рекомендации) в @mcp.tool
- [ ] Обернуть генерацию/обновление Memory Bank в @mcp.tool
- [ ] Обернуть регистрацию webhooks и синхронизацию в @mcp.tool
- [ ] Обернуть federation-операции (pull/push, проксирование) в @mcp.tool

## MCP-ресурсы (Resources)
- [ ] Экспортировать историю изменений (changelog/history) как MCP-ресурс
- [ ] Экспортировать список проектов, задач, правил, шаблонов как MCP-ресурсы
- [ ] Экспортировать состояние Memory Bank как MCP-ресурс

## Безопасность и авторизация
- [ ] Интегрировать JWT-авторизацию FastMCP (или проксировать существующую)
- [ ] Ограничить доступ к инструментам/ресурсам по ролям

## Federation и проксирование
- [ ] Настроить federation между несколькими инстансами через FastMCP
- [ ] Реализовать проксирование инструментов/ресурсов при необходимости

## Документация и тесты
- [ ] Добавить описание FastMCP-интеграции в README.md
- [ ] Добавить примеры использования MCP-инструментов и ресурсов
- [ ] Покрыть MCP-инструменты и ресурсы автотестами
- [ ] Обновить архитектурную схему с учетом FastMCP

## Улучшения и рефакторинг
- [ ] Провести рефакторинг функций для чистого экспорта в FastMCP (выделить бизнес-логику из endpoint'ов)
- [ ] Добавить контекстные комментарии и обновить context.md для новых файлов/модулей 